name: Fetch News Data

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  run_script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Upgrade pip and setuptools
        run: |
          pip install --upgrade pip setuptools

      - name: Install wheel
        run: pip install wheel

      - name: Install dependencies for building gensim
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential  # 컴파일 도구 설치
          sudo apt-get install -y libopenblas-dev liblapack-dev  # gensim 의존성
          sudo apt-get install -y chromium-browser chromium-chromedriver libgsf-1-114

      - name: package install
        run: |
          pip install requests beautifulsoup4 numpy==1.21.2 gensim==3.8.3 flask selenium scipy==1.7.3

      - name: Set up Chrome for Selenium
        run: |
          export CHROME_BIN=/usr/bin/chromium-browser
          export CHROMEDRIVER_BIN=/usr/bin/chromedriver
          export DISPLAY=:99.0
          sudo apt-get install -y xvfb
          Xvfb :99 &

      - name: Run the news script
        run: |
          python news_script.py
        env:
          DISPLAY: :99.0
          CHROME_BIN: /usr/bin/chromium-browser
          CHROMEDRIVER_BIN: /usr/bin/chromedriver

      - name: 변경 사항 커밋 및 푸시
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git add *.db
          git diff-index --quiet HEAD || git commit -m "Update news data (auto)"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
